<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
  <meta name="mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <title>TeamChat Â· Salon</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
</head>
<body class="chat-page">

<!-- â”€â”€ Header â”€â”€ -->
<header>
  <div class="header-left">
    <span class="header-logo">â—ˆ TeamChat</span>
    <span class="room-badge">Salon principal</span>
  </div>
  <div class="header-right">
    <span class="my-pseudo">{{ pseudo }}</span>

    <!-- Bouton "ConnectÃ©s" visible uniquement sur mobile -->
    <button class="drawer-btn" id="drawer-btn" onclick="toggleDrawer()">
      <span class="online-dot"></span>
      <span id="online-count">0</span> en ligne
    </button>

    <a class="logout-btn" href="/logout">Quitter</a>
  </div>
</header>

<!-- â”€â”€ Drawer mobile : liste des connectÃ©s â”€â”€ -->
<div class="mobile-drawer" id="mobile-drawer">
  <p class="mobile-drawer-title">ConnectÃ©s</p>
  <div class="mobile-users" id="mobile-users"></div>
</div>

<div class="main">

  <!-- â”€â”€ Sidebar desktop â”€â”€ -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <p class="sidebar-title">ConnectÃ©s</p>
      <ul class="user-list" id="user-list"></ul>
    </div>

    <div class="voice-section">
      <p class="sidebar-title">Voix</p>

      <div class="mic-select-wrap">
        <span class="mic-select-label">ðŸŽ™ Micro</span>
        <select class="mic-select" id="mic-select-desktop"></select>
      </div>

      <button class="voice-btn" onclick="toggleVoice()" style="margin-top:10px;">
        <span class="voice-icon">ðŸ“ž</span>
        <span class="voice-label">Rejoindre l'appel</span>
      </button>

      <button class="mute-btn" onclick="toggleMute()">
        <span class="mute-icon">ðŸŽ¤</span>
        <span class="mute-label">Micro actif</span>
      </button>

      <div class="peer-audio-list" id="peer-audio-desktop"></div>
    </div>
  </aside>

  <!-- â”€â”€ Zone de chat â”€â”€ -->
  <div class="chat-area">
    <div class="messages" id="messages">
      {% for msg in messages %}
        {% if msg.pseudo == pseudo %}
          <div class="msg mine">
            <div class="msg-meta">
              <span class="msg-pseudo">Vous</span>
              <span>{{ msg.created_at[11:16] if msg.created_at else '' }}</span>
            </div>
            <div class="msg-bubble">{{ msg.content }}</div>
          </div>
        {% else %}
          <div class="msg other">
            <div class="msg-meta">
              <span class="msg-pseudo">{{ msg.pseudo }}</span>
            </div>
            <div class="msg-bubble">{{ msg.content }}</div>
          </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="input-area">
      <textarea
        class="message-input"
        id="msg-input"
        placeholder="Messageâ€¦ (EntrÃ©e pour envoyer)"
        rows="1"
      ></textarea>
      <button class="send-btn" onclick="sendMessage()">â†‘</button>
    </div>
  </div>

</div>

<!-- â”€â”€ Barre voix mobile (fixÃ©e en bas) â”€â”€ -->
<div class="mobile-voice-bar">
  <div class="mic-select-wrap">
    <select class="mic-select" id="mic-select-mobile"></select>
  </div>

  <button class="voice-btn" onclick="toggleVoice()">
    <span class="voice-icon">ðŸ“ž</span>
    <span class="voice-label">Rejoindre</span>
  </button>

  <button class="mute-btn" onclick="toggleMute()" title="Mute">
    <span class="mute-icon">ðŸŽ¤</span>
    <span class="mute-label"></span>
  </button>
</div>

<!-- Ã‰lÃ©ments audio injectÃ©s par JS -->
<div id="audio-container" style="display:none;"></div>

<script>const MY_PSEUDO = {{ pseudo | tojson }};</script>
<script src="{{ url_for('static', filename='app.js') }}"></script>
</body>
</html>
