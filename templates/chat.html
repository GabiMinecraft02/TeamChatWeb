<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>teamchat Â· Salon</title>
  <link href="https://fonts.googleapis.com/css2?family=Syne:wght@400;700;800&family=DM+Mono:ital,wght@0,400;0,500;1,400&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.min.js"></script>
  <style>
    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

    :root {
      --bg: #0a0a0f;
      --surface: #111118;
      --surface2: #16161f;
      --border: #1e1e2e;
      --accent: #7c6aff;
      --accent2: #ff6a9b;
      --green: #4fffb0;
      --text: #e8e8f0;
      --muted: #5a5a7a;
      --me: #7c6aff;
    }

    body {
      background: var(--bg);
      color: var(--text);
      font-family: 'DM Mono', monospace;
      height: 100dvh;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    /* â”€â”€ Header â”€â”€ */
    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      padding: 14px 24px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      flex-shrink: 0;
    }

    .header-left {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .logo {
      font-family: 'Syne', sans-serif;
      font-weight: 800;
      font-size: 1.3rem;
      background: linear-gradient(135deg, #fff 30%, var(--accent) 100%);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }

    .room-badge {
      font-size: 0.7rem;
      color: var(--muted);
      letter-spacing: 0.1em;
      text-transform: uppercase;
      border: 1px solid var(--border);
      padding: 3px 10px;
      border-radius: 20px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .my-pseudo {
      font-size: 0.8rem;
      color: var(--accent);
    }

    .logout-btn {
      font-family: 'DM Mono', monospace;
      font-size: 0.75rem;
      color: var(--muted);
      background: none;
      border: 1px solid var(--border);
      padding: 5px 12px;
      border-radius: 6px;
      cursor: pointer;
      transition: border-color 0.2s, color 0.2s;
    }
    .logout-btn:hover { border-color: var(--accent2); color: var(--accent2); }

    /* â”€â”€ Main layout â”€â”€ */
    .main {
      display: flex;
      flex: 1;
      overflow: hidden;
    }

    /* â”€â”€ Sidebar â”€â”€ */
    .sidebar {
      width: 220px;
      border-right: 1px solid var(--border);
      display: flex;
      flex-direction: column;
      flex-shrink: 0;
      background: var(--surface);
    }

    .sidebar-section {
      padding: 20px 16px 10px;
    }

    .sidebar-title {
      font-size: 0.65rem;
      letter-spacing: 0.18em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 14px;
    }

    .user-list {
      list-style: none;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .user-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 8px 10px;
      border-radius: 8px;
      font-size: 0.85rem;
      transition: background 0.15s;
      animation: fadeIn 0.3s ease;
    }

    .user-item:hover { background: var(--surface2); }

    .user-dot {
      width: 8px;
      height: 8px;
      border-radius: 50%;
      background: var(--green);
      box-shadow: 0 0 6px var(--green);
      flex-shrink: 0;
      animation: pulse 2s ease-in-out infinite;
    }

    @keyframes pulse {
      0%,100% { opacity: 1; }
      50% { opacity: 0.4; }
    }

    .user-name { color: var(--text); }
    .user-name.is-me { color: var(--accent); }

    /* â”€â”€ Voice section â”€â”€ */
    .voice-section {
      padding: 16px;
      border-top: 1px solid var(--border);
      margin-top: auto;
    }

    .voice-btn {
      width: 100%;
      padding: 12px;
      border-radius: 10px;
      border: 1px solid var(--border);
      background: var(--surface2);
      color: var(--text);
      font-family: 'Syne', sans-serif;
      font-weight: 700;
      font-size: 0.85rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      transition: all 0.2s;
    }

    .voice-btn:hover { border-color: var(--accent); }

    .voice-btn.active {
      background: rgba(79,255,176,0.1);
      border-color: var(--green);
      color: var(--green);
      box-shadow: 0 0 16px rgba(79,255,176,0.15);
    }

    .voice-btn.active .mic-icon { animation: micPulse 1s ease-in-out infinite; }

    @keyframes micPulse {
      0%,100% { transform: scale(1); }
      50% { transform: scale(1.2); }
    }

    .peer-audio-list {
      margin-top: 12px;
      display: flex;
      flex-direction: column;
      gap: 6px;
      font-size: 0.72rem;
      color: var(--muted);
    }

    .peer-audio-item {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .audio-wave {
      display: flex;
      gap: 2px;
      align-items: center;
      height: 14px;
    }

    .audio-wave span {
      display: block;
      width: 2px;
      background: var(--green);
      border-radius: 1px;
      animation: wave 0.8s ease-in-out infinite;
    }

    .audio-wave span:nth-child(1) { height: 4px; animation-delay: 0s; }
    .audio-wave span:nth-child(2) { height: 10px; animation-delay: 0.15s; }
    .audio-wave span:nth-child(3) { height: 7px; animation-delay: 0.3s; }
    .audio-wave span:nth-child(4) { height: 12px; animation-delay: 0.45s; }
    .audio-wave span:nth-child(5) { height: 5px; animation-delay: 0.6s; }

    @keyframes wave {
      0%,100% { transform: scaleY(1); }
      50% { transform: scaleY(0.3); }
    }

    /* â”€â”€ Chat area â”€â”€ */
    .chat-area {
      flex: 1;
      display: flex;
      flex-direction: column;
      overflow: hidden;
    }

    .messages {
      flex: 1;
      overflow-y: auto;
      padding: 24px;
      display: flex;
      flex-direction: column;
      gap: 4px;
      scroll-behavior: smooth;
    }

    .messages::-webkit-scrollbar { width: 4px; }
    .messages::-webkit-scrollbar-track { background: transparent; }
    .messages::-webkit-scrollbar-thumb { background: var(--border); border-radius: 2px; }

    .msg {
      display: flex;
      flex-direction: column;
      max-width: 72%;
      animation: fadeIn 0.25s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(6px); }
      to { opacity: 1; transform: translateY(0); }
    }

    .msg.mine { align-self: flex-end; align-items: flex-end; }
    .msg.other { align-self: flex-start; align-items: flex-start; }

    .msg-meta {
      font-size: 0.68rem;
      color: var(--muted);
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .msg-pseudo {
      color: var(--accent);
      font-weight: 500;
    }

    .msg.other .msg-pseudo { color: var(--accent2); }

    .msg-bubble {
      padding: 10px 16px;
      border-radius: 14px;
      font-size: 0.88rem;
      line-height: 1.5;
      word-break: break-word;
    }

    .msg.mine .msg-bubble {
      background: linear-gradient(135deg, var(--accent), #5f4fe8);
      color: #fff;
      border-bottom-right-radius: 4px;
    }

    .msg.other .msg-bubble {
      background: var(--surface2);
      border: 1px solid var(--border);
      border-bottom-left-radius: 4px;
    }

    .system-msg {
      align-self: center;
      font-size: 0.72rem;
      color: var(--muted);
      padding: 4px 14px;
      background: var(--surface2);
      border-radius: 20px;
      margin: 6px 0;
      border: 1px solid var(--border);
      animation: fadeIn 0.25s ease;
    }

    /* â”€â”€ Input area â”€â”€ */
    .input-area {
      padding: 16px 24px;
      border-top: 1px solid var(--border);
      background: var(--surface);
      display: flex;
      gap: 12px;
      align-items: flex-end;
    }

    .message-input {
      flex: 1;
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 10px;
      padding: 12px 16px;
      color: var(--text);
      font-family: 'DM Mono', monospace;
      font-size: 0.9rem;
      outline: none;
      resize: none;
      min-height: 46px;
      max-height: 120px;
      line-height: 1.5;
      transition: border-color 0.2s, box-shadow 0.2s;
    }

    .message-input:focus {
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(124,106,255,0.12);
    }

    .send-btn {
      width: 46px;
      height: 46px;
      border-radius: 10px;
      background: linear-gradient(135deg, var(--accent), #5f4fe8);
      border: none;
      color: #fff;
      font-size: 1.1rem;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: transform 0.15s, box-shadow 0.15s;
      flex-shrink: 0;
    }

    .send-btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(124,106,255,0.4);
    }

    .send-btn:active { transform: scale(0.95); }

    /* Hidden audio elements */
    #audio-container { display: none; }
  </style>
</head>
<body>

<header>
  <div class="header-left">
    <span class="logo">â¬¡ Nexus</span>
    <span class="room-badge">Salon principal</span>
  </div>
  <div class="header-right">
    <span class="my-pseudo">{{ pseudo }}</span>
    <a href="/logout"><button class="logout-btn">Quitter</button></a>
  </div>
</header>

<div class="main">

  <!-- â”€â”€ Sidebar â”€â”€ -->
  <aside class="sidebar">
    <div class="sidebar-section">
      <p class="sidebar-title">ConnectÃ©s</p>
      <ul class="user-list" id="user-list"></ul>
    </div>

    <div class="voice-section">
      <p class="sidebar-title">Voix</p>
      <button class="voice-btn" id="voice-btn" onclick="toggleVoice()">
        <span class="mic-icon">ðŸŽ™</span>
        <span id="voice-label">Rejoindre l'appel</span>
      </button>
      <div class="peer-audio-list" id="peer-audio-list"></div>
    </div>
  </aside>

  <!-- â”€â”€ Chat â”€â”€ -->
  <div class="chat-area">
    <div class="messages" id="messages">
      {% for msg in messages %}
        {% if msg.pseudo == '{{ pseudo }}' %}
        <div class="msg mine">
          <div class="msg-meta"><span class="msg-pseudo">Vous</span><span>{{ msg.created_at[:16] if msg.created_at else '' }}</span></div>
          <div class="msg-bubble">{{ msg.content }}</div>
        </div>
        {% else %}
        <div class="msg other">
          <div class="msg-meta"><span class="msg-pseudo">{{ msg.pseudo }}</span></div>
          <div class="msg-bubble">{{ msg.content }}</div>
        </div>
        {% endif %}
      {% endfor %}
    </div>

    <div class="input-area">
      <textarea class="message-input" id="msg-input" placeholder="Ã‰crire un message... (EntrÃ©e pour envoyer)" rows="1"></textarea>
      <button class="send-btn" onclick="sendMessage()">â†‘</button>
    </div>
  </div>

</div>

<div id="audio-container"></div>

<script>
  const MY_PSEUDO = "{{ pseudo }}";
  const socket = io();

  // â”€â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function scrollBottom() {
    const box = document.getElementById("messages");
    box.scrollTop = box.scrollHeight;
  }

  function timeNow() {
    return new Date().toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' });
  }

  // â”€â”€â”€ Text Chat â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  function appendMessage(pseudo, content, time, isMine) {
    const msgs = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = `msg ${isMine ? 'mine' : 'other'}`;
    div.innerHTML = `
      <div class="msg-meta">
        <span class="msg-pseudo">${isMine ? 'Vous' : pseudo}</span>
        <span>${time}</span>
      </div>
      <div class="msg-bubble">${escapeHtml(content)}</div>
    `;
    msgs.appendChild(div);
    scrollBottom();
  }

  function appendSystem(text) {
    const msgs = document.getElementById("messages");
    const div = document.createElement("div");
    div.className = "system-msg";
    div.textContent = text;
    msgs.appendChild(div);
    scrollBottom();
  }

  function escapeHtml(s) {
    return s.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
  }

  function sendMessage() {
    const input = document.getElementById("msg-input");
    const content = input.value.trim();
    if (!content) return;
    socket.emit("send_message", { content });
    input.value = "";
    input.style.height = "auto";
  }

  // Auto-resize textarea
  document.getElementById("msg-input").addEventListener("input", function() {
    this.style.height = "auto";
    this.style.height = Math.min(this.scrollHeight, 120) + "px";
  });

  // EntrÃ©e pour envoyer, Shift+EntrÃ©e pour retour Ã  la ligne
  document.getElementById("msg-input").addEventListener("keydown", function(e) {
    if (e.key === "Enter" && !e.shiftKey) {
      e.preventDefault();
      sendMessage();
    }
  });

  // â”€â”€â”€ Socket events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  socket.on("new_message", ({ pseudo, content, time }) => {
    appendMessage(pseudo, content, time, pseudo === MY_PSEUDO);
  });

  socket.on("system_message", ({ text }) => {
    appendSystem(text);
  });

  socket.on("user_list", (users) => {
    const ul = document.getElementById("user-list");
    ul.innerHTML = "";
    users.forEach(u => {
      const li = document.createElement("li");
      li.className = "user-item";
      const isMe = u === MY_PSEUDO;
      li.innerHTML = `
        <span class="user-dot"></span>
        <span class="user-name ${isMe ? 'is-me' : ''}">${u}${isMe ? ' (vous)' : ''}</span>
      `;
      ul.appendChild(li);
    });
  });

  scrollBottom();

  // â”€â”€â”€ WebRTC Voice â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  let localStream = null;
  let peerConnections = {}; // sid -> RTCPeerConnection
  let inCall = false;

  const ICE_SERVERS = { iceServers: [{ urls: "stun:stun.l.google.com:19302" }] };

  function toggleVoice() {
    if (!inCall) {
      joinVoice();
    } else {
      leaveVoice();
    }
  }

  async function joinVoice() {
    try {
      localStream = await navigator.mediaDevices.getUserMedia({ audio: true, video: false });
      inCall = true;
      document.getElementById("voice-btn").classList.add("active");
      document.getElementById("voice-label").textContent = "Raccrocher";

      // Demander la liste des pairs existants et crÃ©er des offres
      socket.emit("get_peers");
    } catch (err) {
      alert("Impossible d'accÃ©der au micro : " + err.message);
    }
  }

  function leaveVoice() {
    inCall = false;
    if (localStream) {
      localStream.getTracks().forEach(t => t.stop());
      localStream = null;
    }
    // Fermer toutes les connexions
    Object.values(peerConnections).forEach(pc => pc.close());
    peerConnections = {};
    document.getElementById("audio-container").innerHTML = "";
    document.getElementById("peer-audio-list").innerHTML = "";
    document.getElementById("voice-btn").classList.remove("active");
    document.getElementById("voice-label").textContent = "Rejoindre l'appel";
  }

  async function createPeerConnection(sid, pseudo, isInitiator) {
    const pc = new RTCPeerConnection(ICE_SERVERS);
    peerConnections[sid] = pc;

    // Ajouter pistes locales
    if (localStream) {
      localStream.getTracks().forEach(track => pc.addTrack(track, localStream));
    }

    // Recevoir audio distant
    pc.ontrack = (event) => {
      addRemoteAudio(sid, pseudo, event.streams[0]);
    };

    // ICE candidates
    pc.onicecandidate = (event) => {
      if (event.candidate) {
        socket.emit("webrtc_ice", { target: sid, candidate: event.candidate });
      }
    };

    pc.onconnectionstatechange = () => {
      if (["disconnected", "failed", "closed"].includes(pc.connectionState)) {
        removeRemoteAudio(sid);
        delete peerConnections[sid];
      }
    };

    if (isInitiator) {
      const offer = await pc.createOffer();
      await pc.setLocalDescription(offer);
      socket.emit("webrtc_offer", { target: sid, offer });
    }

    return pc;
  }

  function addRemoteAudio(sid, pseudo, stream) {
    // CrÃ©er Ã©lÃ©ment audio
    let audio = document.getElementById(`audio-${sid}`);
    if (!audio) {
      audio = document.createElement("audio");
      audio.id = `audio-${sid}`;
      audio.autoplay = true;
      document.getElementById("audio-container").appendChild(audio);
    }
    audio.srcObject = stream;

    // Indicateur visuel
    let indicator = document.getElementById(`peer-${sid}`);
    if (!indicator) {
      indicator = document.createElement("div");
      indicator.id = `peer-${sid}`;
      indicator.className = "peer-audio-item";
      indicator.innerHTML = `
        <div class="audio-wave">
          <span></span><span></span><span></span><span></span><span></span>
        </div>
        <span>${pseudo}</span>
      `;
      document.getElementById("peer-audio-list").appendChild(indicator);
    }
  }

  function removeRemoteAudio(sid) {
    const audio = document.getElementById(`audio-${sid}`);
    if (audio) audio.remove();
    const indicator = document.getElementById(`peer-${sid}`);
    if (indicator) indicator.remove();
  }

  // â”€â”€â”€ WebRTC Socket events â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

  socket.on("peer_list", async (peers) => {
    // Initier une connexion WebRTC vers chaque pair existant
    for (const peer of peers) {
      if (!peerConnections[peer.sid]) {
        await createPeerConnection(peer.sid, peer.pseudo, true);
      }
    }
  });

  socket.on("webrtc_offer", async ({ offer, from, pseudo }) => {
    if (!inCall || peerConnections[from]) return;
    const pc = await createPeerConnection(from, pseudo, false);
    await pc.setRemoteDescription(new RTCSessionDescription(offer));
    const answer = await pc.createAnswer();
    await pc.setLocalDescription(answer);
    socket.emit("webrtc_answer", { target: from, answer });
  });

  socket.on("webrtc_answer", async ({ answer, from }) => {
    const pc = peerConnections[from];
    if (pc) {
      await pc.setRemoteDescription(new RTCSessionDescription(answer));
    }
  });

  socket.on("webrtc_ice", async ({ candidate, from }) => {
    const pc = peerConnections[from];
    if (pc && candidate) {
      try {
        await pc.addIceCandidate(new RTCIceCandidate(candidate));
      } catch (e) { /* ignore */ }
    }
  });

  // Nettoyer si dÃ©connectÃ©
  window.addEventListener("beforeunload", leaveVoice);
</script>
</body>
</html>
